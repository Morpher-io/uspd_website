# USPD PoolShare Precision Decision

## Context

The USPD token aims to provide a yield-bearing stablecoin experience where the user's balance increases over time based on the yield generated by the underlying `stETH` collateral. Internally, the `UspdToken` contract tracks user entitlements using a unit called `poolShares`. The user-facing balance (in USPD, pegged to $1) is calculated dynamically based on these internal `poolShares` and a global `YieldFactor` derived from `stETH` rebasing.

The core calculation is:
`USPD_Balance = (PoolShares_Held * YieldFactor) / FACTOR_PRECISION`

We needed to decide on the number of decimals to use for the internal `poolShares` accounting (`_poolShareBalances`, `_totalPoolShares`).

## Decision

**Use 18 decimals for internal `poolShares` accounting.**

## Rationale

1.  **Alignment with USPD:** The user-facing USPD token will use the standard 18 decimals. Using 18 decimals for `poolShares` creates a clean initial mapping: 1 USPD (1e18) minted corresponds to 1 `poolShare` (1e18) being recorded internally. This represents "$1 worth of value at the time of minting".
2.  **Calculation Simplicity:** The formula `USPD_Balance = (PoolShares_Held * YieldFactor) / 1e18` (assuming `FACTOR_PRECISION` is 1e18) directly yields a result with 18 decimals, matching the target USPD decimals without extra scaling factors.
3.  **Sufficient Precision:** Performing the multiplication (`PoolShares_Held * YieldFactor`) before the division preserves intermediate precision up to 36 decimals (18 from shares + 18 from yield factor). This is generally sufficient for accurately reflecting yield accrual without significant rounding errors for typical stablecoin amounts and yield rates.
4.  **Standard Practice:** Using 18 decimals is the common standard for fungible tokens, ensuring compatibility with tooling and explorers if the internal `poolShares` were ever exposed directly (though they are currently planned to be internal).
5.  **Overflow Risk:** While using more decimals (e.g., 36) might seem to offer more precision, it significantly increases the risk of intermediate overflow during the multiplication step (`PoolShares_Held * YieldFactor`) without providing a substantial benefit for this specific calculation. The standard 18 decimals balances precision and overflow risk appropriately.
6.  **Loss of Precision with Fewer Decimals:** Using fewer than 18 decimals (e.g., 9) would lead to unacceptable loss of precision and rounding errors, making it impossible to accurately track small balances or yield accruals.

## Implication

The internal `_poolShareBalances` mapping in `UspdToken` will store values assuming 18 decimals. When a user mints USPD equivalent to `$X`, the contract will update their balance by `X * 1e18` `poolShares`. The `balanceOf` function will then apply the `YieldFactor` to this `poolShare` balance to return the current, yield-adjusted USPD balance (also with 18 decimals).
